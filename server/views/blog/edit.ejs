<% if (!blogData) {%>
    <p>No blog found.</p>
<% } else {%>
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title><%= blogData.title %></title>
        <link rel="stylesheet" href="/style/style.css">
        <link rel="stylesheet" href="/style/blog.css">
    </head>
    <body>
        <div class="header" style="display: grid;">
            <button onclick="save()" style="position: absolute; width: 100px; height: 30px; font-size: large; justify-content: center;">Save</button>
            <label for="title">Title: </label>
            <input type="text" name="title" id="title" style="width: 50%; height: 70%; font-size: 6rem; justify-self: center;" value="<%= blogData.title %>">
            <label for="preview" style="font-size: x-large;">Preview:</label>
            <textarea id="preview" class="preview" name="preview" placeholder="Some text.." style="resize: none; width: 100%; overflow: hidden;"><%= blogData.preview %></textarea> 
            <label for="tags" style="font-size: x-large;">Tags</label>
            <div name="tags">
                <label for="cars" style="font-size: large;">Cars: </label>
                <input type="checkbox" id="cars" name="cars" <% if (blogData.tags.includes("cars")) { %> checked <% } %>>
                <label for="family" style="font-size: large;">Family: </label>
                <input type="checkbox" id="family" name="family" <% if (blogData.tags.includes("family")) { %> checked <% } %>>
                <label for="money" style="font-size: large;">Money: </label>
                <input type="checkbox" id="money" name="money" <% if (blogData.tags.includes("money")) { %> checked <% } %>>
                <label for="computers" style="font-size: large;">Computers: </label>
                <input type="checkbox" id="computers" name="computers" <% if (blogData.tags.includes("computers")) { %> checked <% } %>>
            </div>
        </div>

        <button onclick="newCard()" style="display: flex; width: 100%; height: 30px; font-size: large; justify-content: center; margin-top: 20px;">New post</button>

        <div id="cardList" class="row">
            <% if (blogData.blogList) {%>
                <% for(var i = 0; i < blogData.blogList.length; i++) { %>
                    <% const blog = blogData.blogList[i]; %>
                    <div class="card" id="card_<%= i %>">
                        <button onclick="deleteCard(this)" style="display: flex; position: absolute; align-self: flex-end; width: 80px; font-size: x-large; color: red;justify-content: center;" >Delete</button>
                        <input type="text" class="input" placeholder="Your title.." style="font-size: x-large; width: calc(100% - 90px);" value="<%= blog.title %>">
                        <h5 class="date"><%= blog.date %></h5>
                        <div id="images_<%= i %>" class="images">
                            <% var j = 0; for(j; j < blog.images.length; j++) { %>
                                <div class="imgHolder">
                                    <input type="file" id="images_<%= i %>_imageInput_<%= j %>" name="image" accept="image/*" onchange="previewImage('images_<%= i %>_imageInput_<%= j %>', 'images_<%= i %>_imagePreview_<%= j %>')">
                                    <div id="images_<%= i %>_imagePreview_<%= j %>" class="img">
                                        <img style="max-width: 100%;" src="<%= blog.images[j].src %>" alt="">
                                    </div>
                                </div>
                            <% } %>
                            
                            <% if (blog.images.length < 5) { %>
                                <div class="imgHolder">
                                    <input type="file" id="images_<%= i %>_imageInput_<%= j %>" name="image" accept="image/*" onchange="previewImage('images_<%= i %>_imageInput_<%= j %>', 'images_<%= i %>_imagePreview_<%= j %>')">
                                    <div id="images_<%= i %>_imagePreview_<%= j %>" class="img"></div>
                                </div>
                            <% } %>
                        </div>
                        <h4>Your Text:</h4>
                        <textarea id="content_<%= i %>" class="content" name="content" placeholder="Some text.." style="resize: none; width: 100%; overflow: hidden;"><%= blog.content %></textarea> 
                    </div>
                <% } %>
            <% } %>
        </div>
    <script>

        async function postData(url, data) {
            return await fetch(url, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: {
                    "Content-type": "application/json; charset=UTF-8"
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .catch(error => {
                console.error('There was a problem with your fetch operation:', error);
            });
        }

        async function save() {
            const title = document.getElementById("title").value;
            const preview = document.getElementById("preview").value;
            const cardListChilds = document.getElementById("cardList").children;
            const blogList = Array.from(cardListChilds).map((child) => {
                const title = child.querySelector(".input").value;
                const date = child.querySelector(".date").textContent;
                const images = Array.from(child.querySelectorAll(".images")).map((imgContainer) => {
                    const imgSources = Array.from(imgContainer.querySelectorAll(".img")).map((imgElement) => {
                        if (imgElement.childNodes.length > 0) {
                            console.log(imgElement)
                            console.log(imgElement.childNodes[0])
                            console.log(imgElement.childNodes[0].src)
                            return imgElement.childNodes[0].src;
                        }
                        return "";
                    });

                    return imgSources.filter(src => src).map(src => ({ src: src }));
                });

                const content = child.querySelector(".content").value;

                return {
                    title: title,
                    date: date,
                    images: images.flat(),
                    content: content
                };
            });
            const tags = [
                document.getElementById("cars").checked ? "cars" : null,
                document.getElementById("family").checked ? "cars" : null,
                document.getElementById("money").checked ? "cars" : null,
                document.getElementById("computers").checked ? "cars" : null
            ].filter(tag => tag !== null);

            const data = {
                title: title,
                preview: preview,
                tags: tags,
                blogList: blogList,
            }

            await postData("/blog/edit/<%= blogData.id %>", data)
                .then(response => {
                    console.log('Success:', response);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function newCard() {
            const existingCards = document.getElementById("cardList").children;

            let highestCardId = 0;
            for (const card of existingCards) {
                const cardId = parseInt(card.id.split("_").pop());
                if (cardId > highestCardId) {
                    highestCardId = cardId;
                }
            }
            const nextCardId = highestCardId + 1;

            const cardContainer = document.createElement("div");
            cardContainer.classList.add("card");
            cardContainer.id = "card_" + nextCardId;

            const deleteButton = document.createElement("button");
            deleteButton.textContent = "Delete";
            deleteButton.style.display = "flex";
            deleteButton.style.position = "absolute";
            deleteButton.style.alignSelf = "flex-end";
            deleteButton.style.width = "80px";
            deleteButton.style.fontSize = "x-large";
            deleteButton.style.color = "red";
            deleteButton.style.justifyContent = "center";
            deleteButton.onclick = function() {
                cardContainer.remove();
            };

            const titleInput = document.createElement("input");
            titleInput.type = "text";
            titleInput.placeholder = "Your title..";
            titleInput.style.fontSize = "x-large";
            titleInput.style.width = "calc(100% - 90px)";
            titleInput.classList.add("input");

            const dateElement = document.createElement("h5");
            dateElement.textContent = new Date().toDateString();
            dateElement.classList.add("date");

            const imagesContainer = document.createElement("div");
            imagesContainer.classList.add("images");
            imagesContainer.id = "images_" +nextCardId

            const imageInput = document.createElement("input");
            imageInput.type = "file";
            imageInput.id = `images_${nextCardId}_imageInput_1`;
            imageInput.name = "image";
            imageInput.accept = "image/*";
            imageInput.onchange = function() {
                previewImage(`images_${nextCardId}_imageInput_1`, `images_${nextCardId}_imagePreview_1`);
            };
            
            const imgHolder = document.createElement("div");
            imgHolder.classList.add("imgHolder");
            imgHolder.appendChild(imageInput);

            const imagePreview = document.createElement("div");
            imagePreview.id = `images_${nextCardId}_imagePreview_1`;
            imagePreview.classList.add("img");
            imgHolder.appendChild(imagePreview);

            imagesContainer.appendChild(imgHolder);

            const contentLabel = document.createElement("h4");
            contentLabel.textContent = "Your Text:"

            const contentTextarea = document.createElement("textarea");
            contentTextarea.id = `content_${nextCardId}`;
            contentTextarea.name = "content";
            contentTextarea.placeholder = "Some text..";
            contentTextarea.style.resize = "none";
            contentTextarea.style.width = "100%";
            contentTextarea.style.overflow = "hidden";
            contentTextarea.classList.add("content");
            contentTextarea.addEventListener("input", function() {
                this.style.height = "auto";
                this.style.height = (this.scrollHeight + 2) + "px";
            });

            cardContainer.appendChild(deleteButton);
            cardContainer.appendChild(titleInput);
            cardContainer.appendChild(dateElement);
            cardContainer.appendChild(imagesContainer);
            cardContainer.appendChild(contentLabel);
            cardContainer.appendChild(contentTextarea);

            const firstCard = document.getElementById("cardList").firstElementChild;
            document.getElementById("cardList").insertBefore(cardContainer, firstCard);
        }


        function deleteCard(button) {
            var cardDiv = button.parentElement;
            cardDiv.remove();
        }

        function previewImage(inputId, previewId) {
            const preview = document.getElementById(previewId);
            const fileInput = document.getElementById(inputId);
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const img = document.createElement("img");
                img.src = e.target.result;
                img.alt = "";
                img.style.maxWidth = "100%";
                preview.innerHTML = "";
                preview.appendChild(img);
            };

            reader.readAsDataURL(file);

            const baseInputId = inputId.split("").slice(0, -1).join("");
            const NextInputIdNumber = parseInt(inputId.slice(-1)) + 1;
            if (NextInputIdNumber < 5) {
                const nextInputId = baseInputId + NextInputIdNumber;
                if (!document.getElementById(nextInputId)) {
                    const nextInput = document.createElement("input");
                    nextInput.type = "file";
                    nextInput.id = nextInputId;
                    nextInput.name = "image";
                    nextInput.accept = "image/*";
                    nextInput.onchange = function() {
                        previewImage(nextInputId, nextInputId.replace("imageInput", "imagePreview"));
                    };
                    const imgHolder = document.createElement("div");
                    imgHolder.classList.add("imgHolder");
                    imgHolder.appendChild(nextInput);
                    const imagePreview = document.createElement("div");
                    imagePreview.id = nextInputId.replace("imageInput", "imagePreview");
                    imagePreview.classList.add("img");
                    imgHolder.appendChild(imagePreview);
                    const imagesContainerId = inputId.split("_")[0] + "_" + inputId.split("_")[1];
                    const imagesContainer = document.getElementById(imagesContainerId)
                    imagesContainer.appendChild(imgHolder);
                }
            }
        }

        document.querySelectorAll("textarea").forEach(textarea => {
            textarea.style.height = (textarea.scrollHeight + 2) + "px";
            textarea.addEventListener("input", function() {
                this.style.height = "auto";
                this.style.height = (this.scrollHeight + 2) + "px";
            });
        });
    </script>
    </body>
    </html>
<% } %>